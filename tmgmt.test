<?php

/*
 * @file
 * Contains tests for Translation management
 */

/**
 * Base class for tests.
 */
class TranslationManagementBaseTestCase extends DrupalWebTestCase {

  /**
   * Creates, saves and returns a translator.
   *
   * @return TranslationManagementTranslator
   */
  function createTranslator() {
    $translator = new TranslationManagementTranslator();
    $translator->name = $this->randomName();
    $translator->label = $this->randomString();
    $translator->settings = array(
      'key' => $this->randomName(),
      'another_key' => $this->randomName(),
    );
    $this->assertEqual(SAVED_NEW, $translator->save());

    // Assert that the translater was assigned a tid.
    $this->assertTrue($translator->tid > 0);
    return $translator;
  }

  /**
   * Creates, saves and returns a translation job.
   *
   * @return TranslationManagementJob
   */
  function createJob() {
    $job = new TranslationManagementJob();
    $job->plugin = $this->randomName();
    $job->item_type = $this->randomName();
    $job->item_id = 5;
    $job->source_language = 'en';
    $job->target_language = 'de';
    $job->data = array(
      'title' => array(
        '#text' => $this->randomString(),
        '#label' => $this->randomString(),
        '#translate' => TRUE,
      ),
      'field_body' => array(
        0 => array(
          '#text' => $this->randomString(),
          '#label' => $this->randomString(),
          '#translate' => FALSE,
          '#comment' => $this->randomString(),
        ),
      ),
      'field_collection' => array(
        0 => array(
          'field_whatever' => array(
            0 => array(
              '#text' => $this->randomString(),
              '#label' => $this->randomString(),
              '#translate' => TRUE,
            ),
          ),
        ),
      ),
    );

    $this->assertEqual(SAVED_NEW, $job->save());

    // Assert that the translater was assigned a tid.
    $this->assertTrue($job->tjid > 0);
    return $job;
  }
}

/**
 * Basic CRUD tests.
 */
class TranslationManagementCRUDTestCase extends TranslationManagementBaseTestCase {

  /**
   * Implement getInfo().
   */
  function getInfo() {
    return array(
      'name' => t('CRUD tests'),
      'description' => t('Basic crud operations for jobs and translators'),
      'group' => t('Translation Management'),
    );
  }

  /**
   * Overrides SimplenewsTestCase::setUp()
   */
  function setUp() {
    parent::setUp(array('entity', 'tmgmt'));
  }

  /**
   * Test crud operations of translators.
   */
  function testTranslators() {
    $translator = $this->createTranslator();

    $loaded_translator = tmgmt_translator_load($translator->tid);

    $this->assertEqual($translator->name, $loaded_translator->name);
    $this->assertEqual($translator->label, $loaded_translator->label);
    $this->assertEqual($translator->settings, $loaded_translator->settings);

    // Update the settings.
    $translator->settings['new_key'] = $this->randomString();
    $this->assertEqual(SAVED_UPDATED, $translator->save());

    $loaded_translator = tmgmt_translator_load($translator->tid);

    $this->assertEqual($translator->name, $loaded_translator->name);
    $this->assertEqual($translator->label, $loaded_translator->label);
    $this->assertEqual($translator->settings, $loaded_translator->settings);

    // Delete the translator, make sure the translator is gone.
    $translator->delete();
    $this->assertFalse(tmgmt_translator_load($translator->tid));
  }

  /**
   * Test crud operations of jobs.
   */
  function testJobs() {
    $job = $this->createJob();

    $loaded_job = tmgmt_job_load($job->tjid);

    $this->assertEqual($job->plugin, $loaded_job->plugin);
    $this->assertEqual($job->item_type, $loaded_job->item_type);
    $this->assertEqual($job->item_id, $loaded_job->item_id);
    $this->assertEqual($job->source_language, $loaded_job->source_language);
    $this->assertEqual($job->target_language, $loaded_job->target_language);
    $this->assertEqual($job->data, $loaded_job->data);

    // Assert that the created and changed information has been set to the
    // default value.
    $this->assertTrue($loaded_job->created > 0);
    $this->assertTrue($loaded_job->changed > 0);
    $this->assertEqual(0, $loaded_job->state);

    // Update the settings.
    $job->response = $this->randomString();
    $this->assertEqual(SAVED_UPDATED, $job->save());

    $loaded_job = tmgmt_job_load($job->tjid);

    $this->assertEqual($job->response, $loaded_job->response);

    // Delete the translator, make sure the translator is gone.
    $job->delete();
    $this->assertFalse(tmgmt_job_load($job->tjid));
  }
}
